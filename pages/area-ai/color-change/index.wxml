<view class="page">
  <!-- 自定义导航栏 -->
  <view class="nav-bar" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-bar-inner" style="height: {{navBarHeight}}px;">
      <view class="nav-left" bindtap="onBackTap">
        <image class="nav-back-icon" src="{{navBackIcon}}" mode="aspectFit" />
      </view>
      <view class="nav-title">AI 换色</view>
    </view>
  </view>

  <scroll-view class="content" scroll-y="true">
    <!-- 上传图片区域 -->
    <view wx:if="{{!imageSrc}}" class="upload-panel">
        <view class="upload-inner" bindtap="onChooseImage">
          <image class="upload-icon" src="{{uploadIcon}}" mode="aspectFit" />
          <text class="upload-text">拍照/上传图片</text>
        </view>
    </view>

    <!-- 已选择图片预览 -->
    <view wx:if="{{imageSrc}}" class="image-preview-panel">
      <view class="image-preview">
        <image class="preview-image" src="{{imageSrc}}" mode="aspectFill" bindtap="previewInputImage" />
        <view class="image-actions">
          <button class="action-btn" bindtap="onRemoveImage">重新选择</button>
        </view>
      </view>
    </view>

    <!-- 生成结果预览 -->
    <view wx:if="{{generatedImageSrc}}" class="result-preview-panel">
      <view class="result-preview">
        <image class="preview-image" src="{{generatedImageSrc}}" mode="aspectFill" bindtap="previewImage" />
        <view class="result-actions">
          <button class="action-btn save-btn" bindtap="saveImage">保存图片</button>
        </view>
      </view>
    </view>

    <!-- 产品选择 -->
    <view class="section">
      <view class="section-header">
        <image class="section-dot" src="{{sectionDot}}" mode="aspectFit" />
        <text class="section-title">产品选择</text>
      </view>
      <scroll-view class="product-scroll" scroll-x="true" enable-flex="true">
        <view class="product-list">
          <view wx:if="{{loadingProducts}}" class="loading-text">加载中...</view>
          <view wx:if="{{!loadingProducts}}" class="products-wrapper">
            <!-- 仅展示首行可见色卡 -->
            <view wx:for="{{visibleProducts}}" wx:key="id" class="product-item {{selectedProductMap[item.id] ? 'product-item--active' : ''}}" bindtap="onSelectProduct" data-index="{{item.id}}">
              <view class="product-image-wrapper">
                <image class="product-image" src="{{item.imageSrc}}" mode="aspectFill" />
                <image wx:if="{{selectedProductMap[item.id]}}" class="product-check" src="{{selectedIcon}}" mode="aspectFit" />
              </view>
              <text class="product-name">{{item.colorCode}}</text>
            </view>
            <!-- 更多色卡按钮 -->
            <view class="more-cards-wrapper">
              <button class="more-cards-btn" bindtap="openMoreCards">更多色卡</button>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- 展示所有色卡的网格（放在产品选择图片正下方居中） -->
    <view wx:if="{{showMoreModal}}" class="more-grid">
      <view class="more-grid-inner">
        <view class="more-grid-header">
          <text class="more-grid-title">所有色卡</text>
          <button class="more-grid-close" bindtap="closeMoreCards">关闭</button>
        </view>
        <view class="more-grid-list">
          <view wx:for="{{products}}" wx:key="id" class="more-grid-item" bindtap="onSelectProduct" data-index="{{item.id}}">
            <image class="more-grid-image" src="{{item.imageSrc}}" mode="aspectFill" />
            <text class="more-grid-label">{{item.colorCode}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 工艺选择 -->
    <view class="section">
      <view class="section-header">
        <image class="section-dot" src="{{sectionDot}}" mode="aspectFit" />
        <text class="section-title">风格选择</text>
      </view>
      <view class="craft-list">
        <view wx:for="{{styleOptionsForInterior}}" wx:key="index" class="craft-item {{value0 === index ? 'craft-item--active' : ''}}" bindtap="onChange0" data-index="{{index}}">
          <text class="craft-text">{{item.name}}</text>
        </view>
      </view>
    </view>

    <!-- 自定义选项 -->
    <view wx:if="{{interiorPaintsOptionsActive}}" class="custom-options">
      <!-- 这里可以添加自定义选项的组件 -->
    </view>
  </scroll-view>

  <!-- AI生成进度 -->
  <view wx:if="{{visible}}" class="progress-panel">
    <view class="progress-container">
      <text class="progress-text">AI正在生成中...</text>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{progress}}%"></view>
      </view>
      <text class="progress-percent">{{progress}}%</text>
    </view>
    <button class="cancel-btn" bindtap="closeOverlay">取消生成</button>
  </view>

  <!-- 底部按钮 -->
  <view wx:if="{{!visible}}" class="footer">
    <button class="primary-button" bindtap="onGenerateTap" hover-class="primary-button--hover" disabled="{{!imageSrc}}">
      <text class="primary-button-text">AI生成</text>
    </button>
  </view>

  <!-- 生成结果弹窗 -->
  <view wx:if="{{resultVisible}}" class="result-mask">
    <view class="result-container">
      <!-- 关闭按钮 -->
      <view class="result-close" bindtap="onCloseResult">
        <image class="result-close-icon" src="{{resultCloseIcon}}" mode="aspectFit" />
      </view>
      <!-- 上方大图 -->
      <view class="result-image-wrap">
        <image class="result-image" src="{{resultImage}}" mode="aspectFill" />
      </view>
      <!-- 下方白底内容区域 -->
      <view class="result-panel">
        <view class="result-panel-inner">
          <view class="result-title-row">
            <image class="result-dot" src="{{resultDot}}" mode="aspectFit" />
            <text class="result-title">产品信息</text>
          </view>
          <view class="result-text-row">产品工艺：新中式，外墙</view>
          <view class="result-text-row">使用产品：</view>
          <scroll-view class="result-products" scroll-x="true" enable-flex="true">
            <view class="result-product-list">
              <view wx:for="{{resultProducts}}" wx:key="index" class="result-product-item">
                <image class="result-product-icon" src="{{productIcon}}" mode="aspectFit" />
                <text class="result-product-name">{{item.name}}</text>
              </view>
            </view>
          </scroll-view>
          <button class="result-download" hover-class="result-download--hover">直接下载</button>
        </view>
      </view>
    </view>
  </view>
</view>